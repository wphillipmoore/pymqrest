name: CI - Test and Validate

on:
  pull_request:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  docs-only:
    name: "ci: docs-only"
    runs-on: ubuntu-latest
    outputs:
      docs-only: ${{ steps.detect.outputs.docs-only }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Detect docs-only changes
        id: detect
        uses: wphillipmoore/standard-actions/actions/docs-only-detect@develop

  standards-compliance:
    name: "ci: standards-compliance"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Validate standards
        uses: wphillipmoore/standard-actions/actions/standards-compliance@develop
        with:
          commit-cutoff-sha: "df45093c260def11f409dc4f3ba86e91ec444797"

  dependency-audit:
    name: "ci: dependency-audit"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: wphillipmoore/standard-actions/actions/python/setup@develop
        with:
          python-version: "3.14"

      - name: Install dependencies
        run: uv sync --frozen --group dev

      - name: Run pip-audit (fail on any vulnerability)
        run: uv run pip-audit -r requirements.txt -r requirements-dev.txt

      - name: Run pip-licenses (license compliance)
        run: >-
          uv run pip-licenses
          --allow-only="Apache-2.0;
          Apache-2.0 OR BSD-2-Clause;
          Apache Software License;
          BSD License;
          BSD-2-Clause;
          BSD-3-Clause;
          GPL-3.0-or-later;
          MIT;
          MIT License;
          Mozilla Public License 2.0 (MPL 2.0);
          PSF-2.0;
          Python Software Foundation License"

  release-gates:
    name: "release: gates"
    runs-on: ubuntu-latest
    steps:
      - name: Skip on non-PR events
        if: github.event_name != 'pull_request'
        run: echo "Not a pull request; skipping release gates."

      - name: Checkout code
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python 3.14
        if: github.event_name == 'pull_request'
        uses: actions/setup-python@v6
        with:
          python-version: "3.14"

      - name: PyPI version gates (PRs targeting main)
        if: github.event_name == 'pull_request' && github.base_ref == 'main'
        run: |
          python3 scripts/dev/validate_pypi_version.py --check-not-exists
          python3 scripts/dev/validate_pypi_version.py --check-greater-than-latest

      - name: Changelog version gate (PRs targeting main)
        if: github.event_name == 'pull_request' && github.base_ref == 'main'
        run: python3 scripts/dev/validate_changelog.py

      - name: Version divergence gate (PRs targeting develop)
        if: github.event_name == 'pull_request' && github.base_ref == 'develop'
        uses: wphillipmoore/standard-actions/actions/release-gates/version-divergence@develop
        with:
          head-version-command: python3 -c "import tomllib; from pathlib import Path; print(tomllib.loads(Path('pyproject.toml').read_text())['project']['version'])"
          main-version-command: git show origin/main:pyproject.toml | python3 -c "import sys, tomllib; print(tomllib.loads(sys.stdin.read())['project']['version'])"

  test-and-validate:
    name: "test: unit"
    runs-on: ubuntu-latest
    needs: docs-only
    strategy:
      matrix:
        python-version: ["3.12", "3.13", "3.14"]

    steps:
      - name: Docs-only short-circuit
        if: needs.docs-only.outputs.docs-only == 'true'
        run: echo "Docs-only changes detected; skipping test-and-validate."

      - name: Checkout code
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/checkout@v6

      - name: Fetch base branch for version checks
        if: github.event_name == 'pull_request' && needs.docs-only.outputs.docs-only != 'true'
        run: git fetch origin ${{ github.base_ref }} --depth=1

      - name: Set up Python
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: wphillipmoore/standard-actions/actions/python/setup@develop
        with:
          python-version: ${{ matrix.python-version }}

      - name: Validate version string policy
        if: needs.docs-only.outputs.docs-only != 'true'
        run: python3 scripts/dev/validate_version.py

      - name: Validate dependency specifications
        if: needs.docs-only.outputs.docs-only != 'true'
        run: python3 scripts/dev/validate_dependency_specs.py

      - name: Verify uv.lock sync
        if: needs.docs-only.outputs.docs-only != 'true'
        run: uv lock --check

      - name: Install dependencies
        if: needs.docs-only.outputs.docs-only != 'true'
        run: uv sync --frozen --group dev

      - name: Run ruff check
        if: needs.docs-only.outputs.docs-only != 'true'
        run: uv run ruff check

      - name: Run ruff format check
        if: needs.docs-only.outputs.docs-only != 'true'
        run: uv run ruff format --check .

      - name: Run mypy
        if: needs.docs-only.outputs.docs-only != 'true'
        run: uv run mypy src/

      - name: Run ty
        if: needs.docs-only.outputs.docs-only != 'true'
        run: uv run ty check src

      - name: Run tests with coverage
        if: needs.docs-only.outputs.docs-only != 'true'
        run: |
          uv run pytest \
            --cov=pymqrest \
            --cov-report=term-missing \
            --cov-branch \
            --cov-fail-under=100

  codeql:
    name: "security: codeql"
    runs-on: ubuntu-latest
    needs: docs-only
    permissions:
      security-events: write
    steps:
      - name: Docs-only short-circuit
        if: needs.docs-only.outputs.docs-only == 'true'
        run: echo "Docs-only changes detected; skipping CodeQL."

      - name: Checkout code
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/checkout@v6

      - name: Run CodeQL analysis
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: wphillipmoore/standard-actions/actions/security/codeql@develop
        with:
          language: python

  trivy:
    name: "security: trivy"
    runs-on: ubuntu-latest
    needs: docs-only
    permissions:
      security-events: write
    steps:
      - name: Docs-only short-circuit
        if: needs.docs-only.outputs.docs-only == 'true'
        run: echo "Docs-only changes detected; skipping Trivy."

      - name: Checkout code
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/checkout@v6

      - name: Run Trivy vulnerability scan
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: wphillipmoore/standard-actions/actions/security/trivy@develop
        with:
          scan-type: fs

  semgrep:
    name: "security: semgrep"
    runs-on: ubuntu-latest
    needs: docs-only
    permissions:
      security-events: write
    steps:
      - name: Docs-only short-circuit
        if: needs.docs-only.outputs.docs-only == 'true'
        run: echo "Docs-only changes detected; skipping Semgrep."

      - name: Checkout code
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/checkout@v6

      - name: Run Semgrep SAST scan
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: wphillipmoore/standard-actions/actions/security/semgrep@develop
        with:
          language: python

  integration-tests:
    name: "test: integration"
    runs-on: ubuntu-latest
    needs: docs-only
    steps:
      - name: Docs-only short-circuit
        if: needs.docs-only.outputs.docs-only == 'true'
        run: echo "Docs-only changes detected; skipping integration tests."

      - name: Checkout code
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/checkout@v6

      - name: Set up Python
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: wphillipmoore/standard-actions/actions/python/setup@develop
        with:
          python-version: "3.14"

      - name: Install dependencies
        if: needs.docs-only.outputs.docs-only != 'true'
        run: uv sync --frozen --group dev

      - name: Setup MQ environment
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: wphillipmoore/mq-rest-admin-dev-environment/.github/actions/setup-mq@main
        with:
          project-name: pymqrest

      - name: Run integration tests
        if: needs.docs-only.outputs.docs-only != 'true'
        run: |
          MQ_SKIP_LIFECYCLE=1 \
          PYMQREST_RUN_INTEGRATION=1 \
          uv run pytest -m integration
