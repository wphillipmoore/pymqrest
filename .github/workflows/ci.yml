name: CI - Test and Validate

on:
  pull_request:
  push:
    branches:
      - develop
      - 'release/**'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  docs-only:
    name: docs-only
    runs-on: ubuntu-latest
    outputs:
      docs-only: ${{ steps.detect.outputs.docs-only }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect docs-only changes
        id: detect
        uses: wphillipmoore/standard-actions/actions/docs-only-detect@develop

  standards-compliance:
    name: standards-compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate standards
        uses: wphillipmoore/standard-actions/actions/standards-compliance@develop
        with:
          commit-cutoff-sha: "df45093c260def11f409dc4f3ba86e91ec444797"

  dependency-audit:
    name: dependency-audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: wphillipmoore/standard-actions/actions/python/setup@develop
        with:
          python-version: "3.14"

      - name: Install dependencies
        run: uv sync --frozen --group dev

      - name: Run pip-audit (fail on any vulnerability)
        run: uv run pip-audit -r requirements.txt -r requirements-dev.txt

      - name: Run pip-licenses (license compliance)
        run: >-
          uv run pip-licenses
          --allow-only="Apache-2.0;
          Apache-2.0 OR BSD-2-Clause;
          Apache Software License;
          BSD License;
          BSD-2-Clause;
          BSD-3-Clause;
          GPL-3.0-or-later;
          MIT;
          MIT License;
          Mozilla Public License 2.0 (MPL 2.0);
          PSF-2.0;
          Python Software Foundation License"

  release-gates:
    name: release-gates
    runs-on: ubuntu-latest
    steps:
      - name: Skip on non-PR events
        if: github.event_name != 'pull_request'
        run: echo "Not a pull request; skipping release gates."

      - name: Checkout code
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.14
        if: github.event_name == 'pull_request'
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      - name: PyPI version gates (PRs targeting main)
        if: github.event_name == 'pull_request' && github.base_ref == 'main'
        run: |
          python3 scripts/dev/validate_pypi_version.py --check-not-exists
          python3 scripts/dev/validate_pypi_version.py --check-greater-than-latest

      - name: Changelog version gate (PRs targeting main)
        if: github.event_name == 'pull_request' && github.base_ref == 'main'
        run: python3 scripts/dev/validate_changelog.py

      - name: Version divergence gate (PRs targeting develop)
        if: github.event_name == 'pull_request' && github.base_ref == 'develop'
        run: |
          git fetch origin main --depth=1
          main_version=$(python3 -c "
          import tomllib, subprocess
          text = subprocess.run(
              ['git', 'show', 'origin/main:pyproject.toml'],
              capture_output=True, text=True, check=True
          ).stdout
          print(tomllib.loads(text)['project']['version'])
          ")
          head_version=$(python3 -c "
          import tomllib
          from pathlib import Path
          print(tomllib.loads(Path('pyproject.toml').read_text())['project']['version'])
          ")
          if [ "$main_version" = "$head_version" ]; then
            echo "FAIL: PR version ($head_version) must differ from main ($main_version)."
            exit 1
          fi
          echo "OK: PR version ($head_version) differs from main ($main_version)."

  test-and-validate:
    name: test-and-validate
    runs-on: ubuntu-latest
    needs: docs-only
    strategy:
      matrix:
        python-version: ["3.12", "3.13", "3.14"]

    steps:
      - name: Docs-only short-circuit
        if: needs.docs-only.outputs.docs-only == 'true'
        run: echo "Docs-only changes detected; skipping test-and-validate."

      - name: Checkout code
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/checkout@v4

      - name: Fetch base branch for version checks
        if: github.event_name == 'pull_request' && needs.docs-only.outputs.docs-only != 'true'
        run: git fetch origin ${{ github.base_ref }} --depth=1

      - name: Set up Python
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: wphillipmoore/standard-actions/actions/python/setup@develop
        with:
          python-version: ${{ matrix.python-version }}

      - name: Validate version string policy
        if: needs.docs-only.outputs.docs-only != 'true'
        run: python3 scripts/dev/validate_version.py

      - name: Validate dependency specifications
        if: needs.docs-only.outputs.docs-only != 'true'
        run: python3 scripts/dev/validate_dependency_specs.py

      - name: Verify uv.lock sync
        if: needs.docs-only.outputs.docs-only != 'true'
        run: uv lock --check

      - name: Install dependencies
        if: needs.docs-only.outputs.docs-only != 'true'
        run: uv sync --frozen --group dev

      - name: Run ruff check
        if: needs.docs-only.outputs.docs-only != 'true'
        run: uv run ruff check

      - name: Run ruff format check
        if: needs.docs-only.outputs.docs-only != 'true'
        run: uv run ruff format --check .

      - name: Run mypy
        if: needs.docs-only.outputs.docs-only != 'true'
        run: uv run mypy src/

      - name: Run ty
        if: needs.docs-only.outputs.docs-only != 'true'
        run: uv run ty check src

      - name: Run tests with coverage
        if: needs.docs-only.outputs.docs-only != 'true'
        run: |
          uv run pytest \
            --cov=pymqrest \
            --cov-report=term-missing \
            --cov-branch \
            --cov-fail-under=100

  codeql:
    name: codeql
    runs-on: ubuntu-latest
    needs: docs-only
    if: needs.docs-only.outputs.docs-only != 'true'
    permissions:
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run CodeQL analysis
        uses: wphillipmoore/standard-actions/actions/security/codeql@develop
        with:
          language: python

  trivy:
    name: trivy
    runs-on: ubuntu-latest
    needs: docs-only
    if: needs.docs-only.outputs.docs-only != 'true'
    permissions:
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scan
        uses: wphillipmoore/standard-actions/actions/security/trivy@develop
        with:
          scan-type: fs

  semgrep:
    name: semgrep
    runs-on: ubuntu-latest
    needs: docs-only
    if: needs.docs-only.outputs.docs-only != 'true'
    permissions:
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep SAST scan
        uses: wphillipmoore/standard-actions/actions/security/semgrep@develop
        with:
          language: python

  integration-test:
    name: integration-test
    runs-on: ubuntu-latest
    needs: docs-only
    if: needs.docs-only.outputs.docs-only != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: wphillipmoore/standard-actions/actions/python/setup@develop
        with:
          python-version: "3.14"

      - name: Install dependencies
        run: uv sync --frozen --group dev

      - name: Setup MQ environment
        uses: wphillipmoore/mq-dev-environment/.github/actions/setup-mq@main
        with:
          project-name: pymqrest

      - name: Run integration tests
        run: |
          MQ_SKIP_LIFECYCLE=1 \
          PYMQREST_RUN_INTEGRATION=1 \
          uv run pytest -m integration
